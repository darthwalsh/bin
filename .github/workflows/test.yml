name: Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    # PowerShell and Pester are pre-installed on GitHub Actions runners
    # See: https://docs.github.com/en/actions/tutorials/build-and-test-code/powershell
    # And: https://github.com/actions/runner-images/blob/main/images/ubuntu/Ubuntu2404-Readme.md

    permissions:
      contents: read
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Install ripgrep
      run: |
        sudo apt-get install -y ripgrep
    
    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        version: "latest"
    
    - name: Install global dependencies
      run: |
        ./install-deps.ps1
    
    - name: Run PowerShell tests
      shell: pwsh
      run: |
        $env:PATH = "${PWD}:$env:PATH"
        Invoke-Pester ./tests -Output Detailed
    
    - name: Run Python tests
      run: |
        uv run pytest -v
